      - name: ⚙️ SSH & Deploy to EC2 (Blue-Green)
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            docker pull ${{ secrets.DOCKERHUB_USER }}/${{ env.IMAGE_NAME }}:latest

            active_port=$(curl -s http://localhost | grep -oE '5001|5002')
            if [ "$active_port" == "5001" ]; then
              next_color="green"
              next_port=${{ env.GREEN_PORT }}
            else
              next_color="blue"
              next_port=${{ env.BLUE_PORT }}
            fi

            docker stop flask-$next_color || true
            docker rm flask-$next_color || true

            docker run -d \
              -e VERSION=$next_color \
              -p $next_port:5000 -p 8000:8000 \
              --name flask-$next_color \
              ${{ secrets.DOCKERHUB_USER }}/${{ env.IMAGE_NAME }}:latest

            sudo sed -i "s/5001\|5002/$next_port/" /etc/nginx/sites-available/default
            sudo systemctl reload nginx
